# REAL MySql 4장

- mysql 서버 : 
크게, 
1. mysql 엔진
2. storage 엔진
으로 이루어져있음

## MySql 엔진

- 요청된 SQL문장을 분석하거나 최적화하는 역할 수행.
- 이 엔진은, 
1. 클라이언트로부터의 접속 / 쿼리 요청 핸들링하는 커넥션 핸들러 : 핸들러 API를 통해 MySQL엔진과 데이터를 주고 받음
2. SQL 파서 
3. 전처리기
4. 쿼리의 최적화된 실행을 위한 옵티마이저
로 이뤄짐 


## Storage엔진
- 실제 데이터를 디스크 스토리지에 저장하거나, 데이터 읽어오는 역할 수행
- MySql서버에서 MySql엔진을 여러개 동시에 사용가능.

## 스레드 기반 
- MySQL 서버는 프로세스 기반이 아니라 스레드 기반으로 동작함. 
- performance_schema 디비와 threds테이블을 통해 확인 가능 
- 백그라운드 스레드와 포그라운드 스레드로 구성되어 있음

### 포그라운드 스레드(클라이언트 스레드)
- Mysql 서버에 접속된 클라이언트의 수만큼 존재. 
각 클라이언트 사용자가 요청하는 쿼리 문장을 처리함.
- DBMS 앞단에서 사용자와 통신하기 때문에, 사용자 스레드라고도 함.
- 클라이언트가 커넥션을 종료시, 해당 커넥션을 담당하는 스레드는 다시 스레드 캐시로 되돌아감. 
=> 이때, 일정 개수 이상의 대기 중인 스레드가 있다면 스레드 캐시에 넣지않고 스레드를 종료시켜 일정 개수의 스레드만 스레드 캐시에 존재하도록 함.
- thread_cache_size 시스템 변수로 통제함
- 포그라운드 스레드는 데이터를  1차의 Mysql의 데이터 버퍼나 캐시로부터 가져오고, 없으면 2차로 직접 디스크의 데이터나 인덱스 파일로부터 데이터를 읽어와서 처리함. 

### 백그라운드 스레드
- 다음과 같은 역할 수행
- 1. 로그 기록하는 스레드
- 2. 버퍼의 데이터를 디스크에 기록하는 스레드
- 3. 인서트 버퍼를 병합
- 4. 데이터를 버퍼로 읽어 들임
- 5. 잠금이나 데드락 모니터링함

## 메모리 할당
### 글로벌 메모리 영역
- MySQL 서버가 시작되면서 운영체제로부터 할당됨.
- 클라이언트 스레드 수와 무관하게 하나의 메모리공간만 할당됨.
- 필요에따라 2개 이상의 메모리 공간을 할당받을 수도 있지만, 클라이언트 스레드 수와 무관함.
- 생성된 글로벌 영역이 N개라 하더라도, 모든 스레드에 의해 공유됨 


### 로컬 메모리 영역
- 세션 메모리 영역
- 클라이언트 스레드가 쿼리를 처리하는데 사용하는 메모리 영역 
- MySQL 서버 상에 존재하는 클라이언트 스레드가 쿼리를 처리하는데 사용하는 메모리 영역 
- 세션(클라-mysql서버와의 커넥션) 메모리 영역이라고 칭하기도 함. 
- 로컬 메모리는 각 클라이언트 스레드 별로 독립적으로 할당되며, 절대 공유되어 사용되지 않음
- 대표적으로
1. 커넥션 버퍼
2. 정렬 버퍼(Sort buffer)
3. 조인 버퍼
4. 바이너리 로그 캐시
5. 네트워크 버퍼

등이 있다.


SQL파서 -> SQL 옵티마이저 -> SQL 실행기 (여기까지 MySQL 엔진이 처리함) -> / 데이터 읽기 / 쓰기 (스토리지 엔진의 처리 영역) -> 디스크

## 쿼리 실행구조

- 아래와 같은 순서로 실행
- 1. 쿼리 파서 
사용자 요청으로 들어온 쿼리 문장을 토큰으로 분리하여, 트리형태의 구조로 만들어 내는 작업.
=> 문장의 기본 문법 오류는 이 과정에서 발견되고, 사용자에게 오류 메시지를 전달하게 됨.
- 2. 전처리기
쿼리 문장에 구조적인 문제가 있는지 확인.
각 토큰을 테이블 이름이나 컬럼 이름, 내장 함수와 같은 개체를 맵핑하여, 해당 객체의 존재 여부와 객체의 접근 권한등을 확인하는 과정을 이 단계에서 수행함.
실제 존재하지 않거나, 권한상 사용할 수 없는 개체의 토큰은 이 단계에서 걸러짐.
- 3. 옵티마이저
저렴한 비용으로 가장 빠르게 처리할지를 결정하는 역할 수행. 옵티마이저가 어떻게 더 나은 선택을 유도할 수 있게끔 하는지가 중요. 